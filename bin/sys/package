#!/bin/bash


function update_mirr() {
	rm -f mirrorlist-backup &&
	if [[ -f /etc/pacman.d/mirrorlist ]];then
		sudo cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist-backup
		bb_stat 'mirror backup successfull'
	else
		touch /etc/pacman.d/mirrorlist
		bb_stat 'create mirror file'
	fi
	sudo reflector --country 'Indonesia,Singapore,Malaysia' --ipv4 --save /etc/pacman.d/mirrorlist
	bb_stat 'load fastest mirror'
}


function update_main() {
	bb_rbin_head "UPDATE MAIN PACKAGE"
	bb_stat 'load fastest mirror'
	yes Y | sudo pacman -Syuq &&
	echo 'Update main package'
	sudo rm -fr ~/.cache/*
}


function update_aurs() {
	bb_rbin_head "UPDATE AURS PACKAGE"
	yes y | yay -Syuq &&
	rm -fr ~/.cache/*
	bb_stat 'community package up to date'
}


function update_gits_rbin() {

	bb_rbin_head "UPDATE SCRIPT PACKAGE"

	if [[ -d  /usr/local/rbin ]];then
		sudo rm -fr /usr/local/rbin
	fi
	sudo git clone -q https://github.com/blackbird-package/main-scripts.git /usr/local/rbin > /dev/null &&
	bb_stat 'blackbird package up to date'

	sudo mv -f /usr/local/rbin/profile /etc/profile
	bb_stat 'profile updated'

	sudo mv -f /usr/local/rbin/bashrc /etc/bash.bashrc
	bb_stat 'bashrc updated'	
}


function update_gits_hypr() {
	
	if [[  $XDG_CURRENT_DESKTOP == "Hyprland" ]] ;then

		bb_rbin_head "UPDATE HYPRLAND PACKAGE"

		## update all main blackbird hyprland config 
		config=( 'hypr' 'waybar' 'swaync' 'wofi' 'kitty' 'gtk-3.0' 'gtk-4.0' 'btop' 'mpd' )
		for apps in "${config[@]}"
		do
			if [[ -d  /tmp/$apps ]];then
				sudo rm -fr /tmp/$apps
			fi
			bb_stat "$apps download directory cleaned"

			sudo git clone -q https://github.com/blackbird-hyprland/config-$apps.git /tmp/$apps
			bb_stat "$apps downloaded"	

			if [[ -d  /etc/skel/.config/$apps ]];then
				sudo rm -fr /etc/skel/.config/$apps
				bb_stat "$apps base config cleaned"	
			fi
			
			sudo mv -f /tmp/$apps /etc/skel/.config
			bb_stat "$apps installed"
		done

		## update all user blackbird hyprland config 
		users=$( ls /home )
		for user in "${users[@]}"
		do
			if [[ -d /home/$user/.config/$apps ]];then
				sudo rm -fr /home/$user/.config/$apps
				
			fi
			bb_stat "$apps user directory cleaned"

			sudo cp -fr /etc/skel/.config/* /home/$user/.config/
			bb_stat "$user setting configured"
		done

		## update wallpapper
		wallid=( 1 2 3 )
		for i in "${wallid[@]}"
		do 
			sudo rm /usr/share/hypr/wall$i.png
			sudo cp $ast_path/wall2.png /usr/share/hypr/wall$1.png
		done
		bb_stat "assets setting configured"
	fi
}


function update_gits_gnom() {

	if [[  $XDG_CURRENT_DESKTOP == "Gnome" ]] ;then	
		bb_rbin_head "UPDATE HYPRLAND PACKAGE"
	fi
}


function update_gits() {
	update_gits_rbin &&
	update_gits_hypr &&
	update_gits_gnom
}

function update_conf() {

	bb_rbin_head "UPDATE MAIN CONFIG"

	source /etc/profile &&
	source /etc/bash.bashrc
}


function update() {

	bb_rbin_head "PACKAGE UPDATE"
	read -p "Hello $USER, Do you want update your system right now ? ( Y/n ) " BLACKBIRD_UPDATE

	if [[ $BLACKBIRD_UPDATE == "Y" || $BLACKBIRD_UPDATE == "y" ]];then
		update_mirr &&
		update_main &&
		update_aurs &&
		update_gits &&
		update_conf &&
		cleaner
	fi
}


function cleaner() {
    
	bb_rbin_head "PACKAGE CLEANER"

    yes Y | sudo pacman -Scc > /dev/null 2>&1 &&
    bb_stat 'pacman package clean'

    if [[ ! -z $(pacman -Qtdq) ]];then
        yes Y | sudo pacman -R $(pacman -Qtdq) > /dev/null 2>&1
        bb_stat 'unused package clean'
    fi

    yes Y | yay -Scc > /dev/null 2>&1 &&
    bb_stat 'pacman cache clean'

    yes Y | rm -fr $HOME/.cache/* > /dev/null 2>&1
    bb_stat 'user cache clean'
}
